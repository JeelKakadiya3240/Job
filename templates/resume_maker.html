<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#f8fafc',
                        foreground: '#171717'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-[#f8fafc] flex flex-col">
    <!-- Header -->
    <header class="w-full py-3 shadow-sm bg-white">
        <div class="w-full px-4 flex flex-row items-center justify-between">
            <h1 class="text-3xl font-extrabold tracking-tight text-left flex items-center gap-2">
                <span class="text-[#632D23]">Resume</span>
                <span class="bg-[#632D23] text-white px-2 rounded font-extrabold">Maker</span>
            </h1>
            <a href="/" class="text-[#632D23] hover:text-[#4A221A] text-sm">‚Üê Back to Keyword Extractor</a>
        </div>
    </header>

    <style>
        .resume-main {
            height: 85vh;
            min-height: 600px;
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
        }
        .resume-form-section {
            height: 100%;
            overflow-y: auto;
        }
        .resume-preview-section {
            height: 100%;
            overflow-y: auto;
        }
    </style>

    <!-- Main Content - Left Right Layout -->
    <main class="resume-main">
        <!-- Left Side - Form -->
        <section class="resume-form-section lg:w-1/2 bg-white p-6 border-r border-gray-200 overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Resume Information</h2>
            
            <form id="resumeForm" class="space-y-6">
                <!-- Personal Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Personal Information</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="name" name="name" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="email" name="email" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                            <input type="tel" id="phone" name="phone" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <input type="text" id="location" name="location"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="linkedin" class="block text-sm font-medium text-gray-700 mb-1">LinkedIn URL</label>
                        <input type="url" id="linkedin" name="linkedin"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <!-- Job Description for Keywords -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Job Description for Keywords</h3>
                    <div class="space-y-3">
                        <textarea id="jobDescriptionForKeywords" name="jobDescriptionForKeywords" rows="4"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#8B4513]"
                                  placeholder="Paste the job description to extract relevant keywords for your resume..."></textarea>
                        <button type="button" id="extractKeywordsBtn" 
                                class="bg-[#8B4513] hover:bg-[#A0522D] text-white font-semibold py-2 px-4 rounded-md transition-colors">
                            Extract Keywords
                        </button>
                    </div>
                    
                    <!-- Keywords Display -->
                    <div id="keywordsContainer" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Extracted Keywords:</h4>
                        <div id="keywordsList" class="flex flex-wrap gap-2 mb-3"></div>
                        <div class="text-xs text-gray-500">Selected keywords will be available for AI rewriting</div>
                    </div>
                </div>

                <!-- Professional Summary -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Professional Summary *</h3>
                    <textarea id="summary" name="summary" required rows="4"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#8B4513]"
                              placeholder="Write a compelling professional summary..."></textarea>
                </div>

                <!-- Skills -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Skills</h3>
                    <textarea id="skills" name="skills" rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Enter skills separated by commas (e.g., Python, JavaScript, React)"></textarea>
                </div>

                <!-- Experience -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Work Experience</h3>
                    <div id="experienceContainer" class="space-y-4">
                        <div class="experience-item border border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                                    <input type="text" name="job_title[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                    <input type="text" name="company[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="month" name="start_date[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="month" name="end_date[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-700">Job Description (Bullet Points)</label>
                                    <div class="flex gap-2">
                                        <button type="button" class="ai-rewrite-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md transition-colors">ü§ñ AI Rewrite</button>
                                        <button type="button" class="add-bullet-point text-purple-600 hover:text-purple-800 text-sm font-medium">+ Add Point</button>
                                    </div>
                                </div>
                                <div class="job-description-points space-y-2">
                                    <div class="bullet-point-item flex gap-2" draggable="true">
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="job_description_points[]" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" style="display: none;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addExperience" class="text-purple-600 hover:text-purple-800 text-sm font-medium">+ Add Experience</button>
                </div>

                <!-- Education -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Education</h3>
                    <div id="educationContainer" class="space-y-4">
                        <div class="education-item border border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Degree</label>
                                    <input type="text" name="degree[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Program / Major</label>
                                    <input type="text" name="program[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Institution</label>
                                    <input type="text" name="institution[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input type="text" name="education_location[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="text" name="start_date[]" placeholder="e.g. January 2024" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="text" name="end_date[]" placeholder="e.g. May 2026" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">GPA (Optional)</label>
                                    <input type="text" name="gpa[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addEducation" class="text-purple-600 hover:text-purple-800 text-sm font-medium">+ Add Education</button>
                </div>

                <!-- Projects -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Projects</h3>
                    <div id="projectContainer" class="space-y-4">
                        <div class="project-item border border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Project Title</label>
                                    <input type="text" name="project_title[]" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Role</label>
                                    <input type="text" name="project_role[]" placeholder="e.g. Lead Developer, Team Member" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Project Location</label>
                                    <input type="text" name="project_location[]" placeholder="e.g. GitHub, University, Company" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="text" name="project_start[]" placeholder="e.g. January 2024" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="text" name="project_end[]" placeholder="e.g. May 2024" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-700">Project Description (Bullet Points)</label>
                                    <div class="flex gap-2">
                                        <button type="button" class="ai-rewrite-project-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md transition-colors">ü§ñ AI Rewrite</button>
                                        <button type="button" class="add-project-bullet-point text-purple-600 hover:text-purple-800 text-sm font-medium">+ Add Point</button>
                                    </div>
                                </div>
                                <div class="project-description-points space-y-2">
                                    <div class="bullet-point-item flex gap-2" draggable="true">
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="project_description_points[]" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" style="display: none;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addProject" class="text-purple-600 hover:text-purple-800 text-sm font-medium">+ Add Project</button>
                </div>

                <!-- Template Selection -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Resume Template</h3>
                    <select id="template" name="template" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="modern">Modern</option>
                        <option value="classic">Classic</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-4">
                                    <button type="button" id="previewBtn" class="flex-1 bg-[#8B4513] hover:bg-[#A0522D] text-white font-semibold py-3 px-4 rounded-md transition-colors">
                    Refresh Preview
                </button>
                    <button type="button" id="downloadPdfBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md transition-colors">
                        Download PDF
                    </button>
                </div>
            </form>
        </section>

        <!-- Right Side - Preview -->
        <section class="resume-preview-section lg:w-1/2 bg-gray-50 p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Resume Preview</h2>
                <div class="flex items-center gap-4">
                    <!-- Keyword Coverage Score -->
                    <div id="keywordScoreContainer" class="hidden">
                        <div class="flex items-center gap-2">
                            <div class="text-sm font-medium text-gray-700">Keywords Used:</div>
                            <div id="keywordScore" class="text-lg font-bold text-[#8B4513]">0</div>
                            <div class="text-sm text-gray-500">/</div>
                            <div id="keywordTotal" class="text-lg font-bold text-gray-700">0</div>
                            <div class="text-xs text-gray-500">keywords</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Auto-updates as you type</span>
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div id="resumePreview" class="bg-white border border-gray-200 rounded-lg shadow-sm min-h-[600px]">
                <div class="text-center text-gray-500 py-20">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="text-lg font-semibold mb-2">Resume Preview</h3>
                    <p class="mt-2 text-sm">Start typing in the form to see your resume preview update in real-time.</p>
                    <div class="mt-4 flex items-center justify-center gap-2 text-xs text-gray-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Real-time updates
                    </div>
                </div>
            </div>
        </section>
    </main>

    <style>
        /* A4 Preview Styles - Exact PDF dimensions with pagination support */
        #resumePreview {
            width: 210mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform-origin: top left;
            position: relative;
            /* Remove height constraint and overflow hidden to allow pagination */
        }
        
        /* Paginated container that automatically creates new pages */
        .resume-paginated-container {
            width: 210mm;
            background: white;
            padding: 0.5in;
            box-sizing: border-box;
            font-size: 11pt;
            line-height: 1.4;
            font-family: Arial, sans-serif;
        }
        
        /* Single page container - only one page allowed */
        .resume-page {
            width: 210mm;
            height: 297mm;
            background: white;
            margin-bottom: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            max-height: 297mm;
        }
        
        .resume-page-content {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 0.5in;
            margin: 0;
            overflow: hidden;
        }
        
        /* Responsive scaling for smaller screens */
        @media (max-width: 1200px) {
            #resumePreview {
                width: 100%;
                max-width: 210mm;
            }
            
            .resume-paginated-container {
                width: 100%;
                max-width: 210mm;
                padding: 0.3in;
            }
            
            .resume-page {
                width: 100%;
                max-width: 210mm;
                height: 297mm;
                max-height: 297mm;
                overflow: hidden;
            }
            
            .resume-page-content {
                padding: 0.3in;
                overflow: hidden;
            }
        }
        
        /* Keyword highlighting styles */
        .keyword-highlight {
            background-color: rgba(139, 69, 19, 0.15);
            border-radius: 3px;
            padding: 1px 2px;
            border: 1px solid rgba(139, 69, 19, 0.3);
            font-weight: 500;
            color: #8B4513;
        }
    </style>
    
    <script>
        // Global keywords storage
        let extractedKeywords = [];
        
        // Keyword extraction functionality
        document.getElementById('extractKeywordsBtn').addEventListener('click', async function() {
            const jobDescription = document.getElementById('jobDescriptionForKeywords').value.trim();
            
            if (!jobDescription) {
                alert('Please enter a job description first.');
                return;
            }
            
            // Show loading state
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
                Extracting...
            `;
            
            try {
                const response = await fetch('/extract-keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ job_description: jobDescription })
                });
                
                const data = await response.json();
                
                if (response.ok && data.keywords) {
                    extractedKeywords = data.keywords;
                    displayKeywords(data.keywords);
                    saveKeywordsToStorage(data.keywords);
                    // Calculate keyword coverage with new keywords
                    calculateKeywordCoverage();
                } else {
                    alert('Failed to extract keywords. Please try again.');
                }
            } catch (err) {
                alert('Failed to extract keywords. Please check your connection.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Extract Keywords';
            }
        });
        
        // Display keywords
        function displayKeywords(keywords) {
            const container = document.getElementById('keywordsContainer');
            const list = document.getElementById('keywordsList');
            
            list.innerHTML = '';
            keywords.forEach(keyword => {
                const keywordDiv = document.createElement('div');
                keywordDiv.className = 'bg-[#8B4513] text-white px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-[#A0522D] transition-colors';
                keywordDiv.textContent = keyword;
                keywordDiv.onclick = () => toggleKeywordSelection(keywordDiv, keyword);
                list.appendChild(keywordDiv);
            });
            
            container.classList.remove('hidden');
        }
        
        // Toggle keyword selection
        function toggleKeywordSelection(element, keyword) {
            element.classList.toggle('bg-[#8B4513]');
            element.classList.toggle('bg-green-600');
            
            if (element.classList.contains('bg-green-600')) {
                if (!window.selectedKeywords) window.selectedKeywords = [];
                window.selectedKeywords.push(keyword);
            } else {
                window.selectedKeywords = window.selectedKeywords.filter(k => k !== keyword);
            }
            
            saveKeywordsToStorage(extractedKeywords);
        }
        
        // Save keywords to localStorage
        function saveKeywordsToStorage(keywords) {
            localStorage.setItem('extractedKeywords', JSON.stringify(keywords));
            localStorage.setItem('selectedKeywords', JSON.stringify(window.selectedKeywords || []));
        }
        
        // Load keywords from localStorage
        function loadKeywordsFromStorage() {
            const keywords = localStorage.getItem('extractedKeywords');
            const selected = localStorage.getItem('selectedKeywords');
            
            if (keywords) {
                extractedKeywords = JSON.parse(keywords);
                displayKeywords(extractedKeywords);
                // Calculate initial keyword coverage
                calculateKeywordCoverage();
            }
            
            if (selected) {
                window.selectedKeywords = JSON.parse(selected);
            }
        }
        
        // Save form data to localStorage
        function saveFormData() {
            const form = document.getElementById('resumeForm');
            const formData = new FormData(form);
            const data = {};
            
            // Collect all form data
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const baseKey = key.slice(0, -2);
                    if (!data[baseKey]) data[baseKey] = [];
                    data[baseKey].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            // Process bullet points for job descriptions properly
            data.job_description = [];
            const experienceItems = document.querySelectorAll('.experience-item');
            
            experienceItems.forEach((item, index) => {
                const bulletPoints = item.querySelectorAll('input[name="job_description_points[]"]');
                const points = [];
                
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        points.push(input.value.trim());
                    }
                });
                
                data.job_description.push(points);
            });
            
            // Process bullet points for project descriptions
            data.project_description = [];
            const projectItems = document.querySelectorAll('.project-item');
            
            projectItems.forEach((item, index) => {
                const bulletPoints = item.querySelectorAll('input[name="project_description_points[]"]');
                const points = [];
                
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        points.push(input.value.trim());
                    }
                });
                
                data.project_description.push(points);
            });
            
            // Save to localStorage
            localStorage.setItem('resumeFormData', JSON.stringify(data));
        }
        
        // Load form data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem('resumeFormData');
            if (savedData) {
                const data = JSON.parse(savedData);
                const form = document.getElementById('resumeForm');
                
                // Fill in basic fields
                Object.keys(data).forEach(key => {
                    if (!key.endsWith('[]')) {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = data[key];
                        }
                    }
                });
                
                // Fill in array fields (experience, education)
                if (data.job_title && data.job_title.length > 0) {
                    // Remove existing experience items except the first one
                    const experienceContainer = document.getElementById('experienceContainer');
                    while (experienceContainer.children.length > 1) {
                        experienceContainer.removeChild(experienceContainer.lastChild);
                    }
                    
                    // Add saved experience items
                    for (let i = 0; i < data.job_title.length; i++) {
                        if (i === 0) {
                            // Fill first item
                            const firstItem = experienceContainer.children[0];
                            if (data.job_title[i]) firstItem.querySelector('[name="job_title[]"]').value = data.job_title[i];
                            if (data.company && data.company[i]) firstItem.querySelector('[name="company[]"]').value = data.company[i];
                            if (data.start_date && data.start_date[i]) firstItem.querySelector('[name="start_date[]"]').value = data.start_date[i];
                            if (data.end_date && data.end_date[i]) firstItem.querySelector('[name="end_date[]"]').value = data.end_date[i];
                            
                            // Fill bullet points for first item
                            if (data.job_description && data.job_description[i]) {
                                const bulletPointsContainer = firstItem.querySelector('.job-description-points');
                                bulletPointsContainer.innerHTML = '';
                                
                                data.job_description[i].forEach((point, pointIndex) => {
                                    const bulletPoint = document.createElement('div');
                                    bulletPoint.className = 'bullet-point-item flex gap-2';
                                    bulletPoint.draggable = true;
                                    bulletPoint.innerHTML = `
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="job_description_points[]" value="${point}" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${data.job_description[i].length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                                    `;
                                    bulletPointsContainer.appendChild(bulletPoint);
                                    attachDragAndDropListeners(bulletPoint, bulletPointsContainer);
                                });
                                
                                // Reattach bullet point listeners
                                attachBulletPointListeners(firstItem);
                            }
                        } else {
                            // Add new items for additional experiences
                            document.getElementById('addExperience').click();
                            const newItem = experienceContainer.children[experienceContainer.children.length - 1];
                            if (data.job_title[i]) newItem.querySelector('[name="job_title[]"]').value = data.job_title[i];
                            if (data.company && data.company[i]) newItem.querySelector('[name="company[]"]').value = data.company[i];
                            if (data.start_date && data.start_date[i]) newItem.querySelector('[name="start_date[]"]').value = data.start_date[i];
                            if (data.end_date && data.end_date[i]) newItem.querySelector('[name="end_date[]"]').value = data.end_date[i];
                            
                            // Fill bullet points for additional items
                            if (data.job_description && data.job_description[i]) {
                                const bulletPointsContainer = newItem.querySelector('.job-description-points');
                                bulletPointsContainer.innerHTML = '';
                                
                                data.job_description[i].forEach((point, pointIndex) => {
                                    const bulletPoint = document.createElement('div');
                                    bulletPoint.className = 'bullet-point-item flex gap-2';
                                    bulletPoint.draggable = true;
                                    bulletPoint.innerHTML = `
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="job_description_points[]" value="${point}" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${data.job_description[i].length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                                    `;
                                    bulletPointsContainer.appendChild(bulletPoint);
                                    attachDragAndDropListeners(bulletPoint, bulletPointsContainer);
                                });
                                
                                // Reattach bullet point listeners
                                attachBulletPointListeners(newItem);
                            }
                        }
                    }
                }
                
                // Fill in education
                if (data.degree && data.degree.length > 0) {
                    const educationContainer = document.getElementById('educationContainer');
                    while (educationContainer.children.length > 1) {
                        educationContainer.removeChild(educationContainer.lastChild);
                    }
                    
                    for (let i = 0; i < data.degree.length; i++) {
                        if (i === 0) {
                            const firstItem = educationContainer.children[0];
                            if (data.degree[i]) firstItem.querySelector('[name="degree[]"]').value = data.degree[i];
                            if (data.program && data.program[i]) firstItem.querySelector('[name="program[]"]').value = data.program[i];
                            if (data.institution && data.institution[i]) firstItem.querySelector('[name="institution[]"]').value = data.institution[i];
                            if (data.education_location && data.education_location[i]) firstItem.querySelector('[name="education_location[]"]').value = data.education_location[i];
                            if (data.start_date && data.start_date[i]) firstItem.querySelector('[name="start_date[]"]').value = data.start_date[i];
                            if (data.end_date && data.end_date[i]) firstItem.querySelector('[name="end_date[]"]').value = data.end_date[i];
                            if (data.gpa && data.gpa[i]) firstItem.querySelector('[name="gpa[]"]').value = data.gpa[i];
                        } else {
                            document.getElementById('addEducation').click();
                            const newItem = educationContainer.children[educationContainer.children.length - 1];
                            if (data.degree[i]) newItem.querySelector('[name="degree[]"]').value = data.degree[i];
                            if (data.program && data.program[i]) newItem.querySelector('[name="program[]"]').value = data.program[i];
                            if (data.institution && data.institution[i]) newItem.querySelector('[name="institution[]"]').value = data.institution[i];
                            if (data.education_location && data.education_location[i]) newItem.querySelector('[name="education_location[]"]').value = data.education_location[i];
                            if (data.start_date && data.start_date[i]) newItem.querySelector('[name="start_date[]"]').value = data.start_date[i];
                            if (data.end_date && data.end_date[i]) newItem.querySelector('[name="end_date[]"]').value = data.end_date[i];
                            if (data.gpa && data.gpa[i]) newItem.querySelector('[name="gpa[]"]').value = data.gpa[i];
                        }
                    }
                }
                
                // Fill in projects
                if (data.project_title && data.project_title.length > 0) {
                    const projectContainer = document.getElementById('projectContainer');
                    while (projectContainer.children.length > 1) {
                        projectContainer.removeChild(projectContainer.lastChild);
                    }
                    
                    for (let i = 0; i < data.project_title.length; i++) {
                        if (i === 0) {
                            const firstItem = projectContainer.children[0];
                            if (data.project_title[i]) firstItem.querySelector('[name="project_title[]"]').value = data.project_title[i];
                            if (data.project_role && data.project_role[i]) firstItem.querySelector('[name="project_role[]"]').value = data.project_role[i];
                            if (data.project_location && data.project_location[i]) firstItem.querySelector('[name="project_location[]"]').value = data.project_location[i];
                            if (data.project_start && data.project_start[i]) firstItem.querySelector('[name="project_start[]"]').value = data.project_start[i];
                            if (data.project_end && data.project_end[i]) firstItem.querySelector('[name="project_end[]"]').value = data.project_end[i];
                            
                            // Fill bullet points for first project
                            if (data.project_description && data.project_description[i]) {
                                const bulletPointsContainer = firstItem.querySelector('.project-description-points');
                                bulletPointsContainer.innerHTML = '';
                                
                                data.project_description[i].forEach((point, pointIndex) => {
                                    const bulletPoint = document.createElement('div');
                                    bulletPoint.className = 'bullet-point-item flex gap-2';
                                    bulletPoint.draggable = true;
                                    bulletPoint.innerHTML = `
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="project_description_points[]" value="${point}" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${data.project_description[i].length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                                    `;
                                    bulletPointsContainer.appendChild(bulletPoint);
                                    attachDragAndDropListeners(bulletPoint, bulletPointsContainer);
                                });
                                
                                // Reattach bullet point listeners
                                attachProjectBulletPointListeners(firstItem);
                            }
                        } else {
                            // Add new items for additional projects
                            document.getElementById('addProject').click();
                            const newItem = projectContainer.children[projectContainer.children.length - 1];
                            if (data.project_title[i]) newItem.querySelector('[name="project_title[]"]').value = data.project_title[i];
                            if (data.project_role && data.project_role[i]) newItem.querySelector('[name="project_role[]"]').value = data.project_role[i];
                            if (data.project_location && data.project_location[i]) newItem.querySelector('[name="project_location[]"]').value = data.project_location[i];
                            if (data.project_start && data.project_start[i]) newItem.querySelector('[name="project_start[]"]').value = data.project_start[i];
                            if (data.project_end && data.project_end[i]) newItem.querySelector('[name="project_end[]"]').value = data.project_end[i];
                            
                            // Fill bullet points for additional projects
                            if (data.project_description && data.project_description[i]) {
                                const bulletPointsContainer = newItem.querySelector('.project-description-points');
                                bulletPointsContainer.innerHTML = '';
                                
                                data.project_description[i].forEach((point, pointIndex) => {
                                    const bulletPoint = document.createElement('div');
                                    bulletPoint.className = 'bullet-point-item flex gap-2';
                                    bulletPoint.draggable = true;
                                    bulletPoint.innerHTML = `
                                        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                            </svg>
                                        </div>
                                        <input type="text" name="project_description_points[]" value="${point}" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${data.project_description[i].length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                                    `;
                                    bulletPointsContainer.appendChild(bulletPoint);
                                    attachDragAndDropListeners(bulletPoint, bulletPointsContainer);
                                });
                                
                                // Reattach bullet point listeners
                                attachProjectBulletPointListeners(newItem);
                            }
                        }
                    }
                }
            }
        }
        
        // Auto-save form data when user types
        function setupAutoSave() {
            const form = document.getElementById('resumeForm');
            form.addEventListener('input', saveFormData);
            form.addEventListener('change', saveFormData);
        }
        
        // Real-time preview functionality
        let previewTimeout;
        function setupRealTimePreview() {
            const form = document.getElementById('resumeForm');
            
            // Add event listeners for all form inputs
            form.addEventListener('input', function() {
                // Clear existing timeout
                clearTimeout(previewTimeout);
                
                // Set a new timeout to update preview after user stops typing
                previewTimeout = setTimeout(() => {
                    updateResumePreview();
                    // Also calculate keyword coverage in real-time
                    calculateKeywordCoverage();
                }, 500); // 500ms delay
            });
            
            form.addEventListener('change', function() {
                // Update immediately on change events (dropdowns, checkboxes, etc.)
                clearTimeout(previewTimeout);
                updateResumePreview();
                // Also calculate keyword coverage immediately
                calculateKeywordCoverage();
            });
        }
        
        // Update resume preview with current form data
        async function updateResumePreview() {
            const previewContainer = document.getElementById('resumePreview');
            const previewBtn = document.getElementById('previewBtn');
            
            // Show loading state
            previewBtn.disabled = true;
            previewBtn.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
                Updating...
            `;
            
            const formData = new FormData(document.getElementById('resumeForm'));
            const data = {};
            
            // Collect form data
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const baseKey = key.slice(0, -2);
                    if (!data[baseKey]) data[baseKey] = [];
                    data[baseKey].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            // Process bullet points for job descriptions
            data.job_description = [];
            const experienceItems = document.querySelectorAll('.experience-item');
            
            experienceItems.forEach((item, index) => {
                const bulletPoints = item.querySelectorAll('input[name="job_description_points[]"]');
                const points = [];
                
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        points.push(input.value.trim());
                    }
                });
                
                if (points.length > 0) {
                    data.job_description.push(points);
                } else {
                    // Add empty array for experience items without bullet points
                    data.job_description.push([]);
                }
            });
            
            // Process bullet points for project descriptions
            data.project_description = [];
            const projectItems = document.querySelectorAll('.project-item');
            
            projectItems.forEach((item, index) => {
                const bulletPoints = item.querySelectorAll('input[name="project_description_points[]"]');
                const points = [];
                
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        points.push(input.value.trim());
                    }
                });
                
                if (points.length > 0) {
                    data.project_description.push(points);
                } else {
                    // Add empty array for project items without bullet points
                    data.project_description.push([]);
                }
            });
            
            // Add template
            data.template = document.getElementById('template').value;
            
            try {
                const response = await fetch('/generate-resume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.resume_html) {
                    // Apply pagination to the resume content
                    const paginatedHtml = applyPagination(result.resume_html);
                    previewContainer.innerHTML = paginatedHtml;
                    // Store the HTML for download
                    window.currentResumeHtml = result.resume_html;
                    
                    // Calculate and display keyword coverage
                    calculateKeywordCoverage();
                    
                    // Show success message
                    showPreviewMessage('Preview updated successfully!', 'success');
                } else {
                    console.error('Failed to update preview:', result.error);
                    showPreviewMessage('Failed to update preview. Please try again.', 'error');
                }
            } catch (err) {
                console.error('Failed to update preview:', err);
                showPreviewMessage('Network error. Please check your connection.', 'error');
            } finally {
                // Reset button state
                previewBtn.disabled = false;
                previewBtn.textContent = 'Refresh Preview';
            }
        }
        
        // Function to show preview messages
        function showPreviewMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove message after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Calculate keyword coverage score
        function calculateKeywordCoverage() {
            if (!extractedKeywords || extractedKeywords.length === 0) {
                document.getElementById('keywordScoreContainer').classList.add('hidden');
                return;
            }
            
            // Get all text content from the resume
            const resumeText = getResumeText();
            const foundKeywords = [];
            
            // Check each keyword against resume text
            extractedKeywords.forEach(keyword => {
                const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                if (regex.test(resumeText)) {
                    foundKeywords.push(keyword);
                }
            });
            
            // Calculate score
            const score = Math.round((foundKeywords.length / extractedKeywords.length) * 100);
            const scoreElement = document.getElementById('keywordScore');
            const totalElement = document.getElementById('keywordTotal');
            const container = document.getElementById('keywordScoreContainer');
            
            // Update display with actual counts
            scoreElement.textContent = foundKeywords.length;
            totalElement.textContent = extractedKeywords.length;
            
            // Color coding based on percentage
            if (score >= 80) {
                scoreElement.className = 'text-lg font-bold text-green-600';
            } else if (score >= 60) {
                scoreElement.className = 'text-lg font-bold text-yellow-600';
            } else {
                scoreElement.className = 'text-lg font-bold text-red-600';
            }
            
            // Show container
            container.classList.remove('hidden');
            
            // Highlight keywords in the preview
            highlightKeywordsInPreview(foundKeywords);
            
            return { score, foundKeywords, totalKeywords: extractedKeywords.length };
        }
        
        // Highlight keywords in the resume preview
        function highlightKeywordsInPreview(foundKeywords) {
            const previewContainer = document.getElementById('resumePreview');
            if (!previewContainer || !foundKeywords.length) return;
            
            // Get the resume content
            const resumeContent = previewContainer.querySelector('.resume-page-content');
            if (!resumeContent) return;
            
            // Create a copy of the content for highlighting
            let content = resumeContent.innerHTML;
            
            // Highlight each found keyword
            foundKeywords.forEach(keyword => {
                const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedKeyword})`, 'gi');
                content = content.replace(regex, '<span class="keyword-highlight">$1</span>');
            });
            
            // Update the preview content
            resumeContent.innerHTML = content;
        }
        
        // Get all text content from resume form
        function getResumeText() {
            const form = document.getElementById('resumeForm');
            const formData = new FormData(form);
            let text = '';
            
            // Collect all text inputs
            for (let [key, value] of formData.entries()) {
                if (value && typeof value === 'string') {
                    text += ' ' + value.toLowerCase();
                }
            }
            
            // Add bullet points from experiences
            const experienceItems = document.querySelectorAll('.experience-item');
            experienceItems.forEach(item => {
                const bulletPoints = item.querySelectorAll('input[name="job_description_points[]"]');
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        text += ' ' + input.value.toLowerCase();
                    }
                });
            });
            
            // Add bullet points from projects
            const projectItems = document.querySelectorAll('.project-item');
            projectItems.forEach(item => {
                const bulletPoints = item.querySelectorAll('input[name="project_description_points[]"]');
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        text += ' ' + input.value.toLowerCase();
                    }
                });
            });
            
            return text;
        }
        
        // Function to apply single page constraint to resume content
        function applyPagination(resumeHtml) {
            // Highlight keywords in the HTML content
            const highlightedHtml = highlightKeywordsInGeneratedHTML(resumeHtml);
            
            // Always return only one page with overflow hidden
            return `<div class="resume-page" style="overflow: hidden;"><div class="resume-page-content">${highlightedHtml}</div></div>`;
        }
        
        // Function to highlight keywords in the generated HTML
        function highlightKeywordsInGeneratedHTML(htmlContent) {
            if (!extractedKeywords || extractedKeywords.length === 0) return htmlContent;
            
            let highlightedContent = htmlContent;
            
            // Highlight each keyword
            extractedKeywords.forEach(keyword => {
                const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedKeyword})`, 'gi');
                highlightedContent = highlightedContent.replace(regex, '<span class="keyword-highlight">$1</span>');
            });
            
            return highlightedContent;
        }
        
        // Add Experience
        document.getElementById('addExperience').addEventListener('click', function() {
            const container = document.getElementById('experienceContainer');
            const newItem = container.children[0].cloneNode(true);
            
            // Clear the values
            newItem.querySelectorAll('input, textarea').forEach(input => input.value = '');
            
            // Reset bullet points to just one
            const bulletPointsContainer = newItem.querySelector('.job-description-points');
            bulletPointsContainer.innerHTML = `
                <div class="bullet-point-item flex gap-2" draggable="true">
                    <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                        </svg>
                    </div>
                    <input type="text" name="job_description_points[]" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" style="display: none;">√ó</button>
                </div>
            `;
            
            // Reattach event listeners
            attachBulletPointListeners(newItem);
            
            // Attach drag and drop to the new bullet point
            const newBulletPoint = bulletPointsContainer.querySelector('.bullet-point-item');
            attachDragAndDropListeners(newBulletPoint, bulletPointsContainer);
            
            container.appendChild(newItem);
            
            // Trigger real-time preview update
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                updateResumePreview();
            }, 500);
        });

        // Add bullet point functionality
        function attachBulletPointListeners(container) {
            // Add bullet point
            container.querySelector('.add-bullet-point').addEventListener('click', function() {
                const bulletPointsContainer = container.querySelector('.job-description-points');
                const newBulletPoint = document.createElement('div');
                newBulletPoint.className = 'bullet-point-item flex gap-2';
                newBulletPoint.draggable = true;
                newBulletPoint.innerHTML = `
                    <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                        </svg>
                    </div>
                    <input type="text" name="job_description_points[]" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium">√ó</button>
                `;
                bulletPointsContainer.appendChild(newBulletPoint);
                
                // Attach drag and drop listeners to new bullet point
                attachDragAndDropListeners(newBulletPoint, bulletPointsContainer);
                
                // Show remove buttons if more than one bullet point
                const bulletPoints = bulletPointsContainer.querySelectorAll('.bullet-point-item');
                bulletPoints.forEach((item, index) => {
                    const removeBtn = item.querySelector('.remove-bullet-point');
                    if (bulletPoints.length > 1) {
                        removeBtn.style.display = 'block';
                    } else {
                        removeBtn.style.display = 'none';
                    }
                });
                
                // Save data after adding bullet point
                saveFormData();
                
                // Trigger real-time preview update
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(() => {
                    updateResumePreview();
                }, 500);
            });

            // Remove bullet point
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-bullet-point')) {
                    const bulletPointItem = e.target.closest('.bullet-point-item');
                    const bulletPointsContainer = bulletPointItem.parentElement;
                    bulletPointItem.remove();
                    
                    // Hide remove button if only one bullet point remains
                    const remainingBulletPoints = bulletPointsContainer.querySelectorAll('.bullet-point-item');
                    remainingBulletPoints.forEach((item, index) => {
                        const removeBtn = item.querySelector('.remove-bullet-point');
                        if (remainingBulletPoints.length > 1) {
                            removeBtn.style.display = 'block';
                        } else {
                            removeBtn.style.display = 'none';
                        }
                    });
                    
                    // Save data after removing bullet point
                    saveFormData();
                    
                    // Trigger real-time preview update
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        updateResumePreview();
                    }, 500);
                }
            });
        }

        // Drag and drop functionality for bullet points
        function attachDragAndDropListeners(bulletPoint, container) {
            bulletPoint.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', '');
                this.classList.add('opacity-50');
            });
            
            bulletPoint.addEventListener('dragend', function(e) {
                this.classList.remove('opacity-50');
            });
            
            bulletPoint.addEventListener('dragover', function(e) {
                e.preventDefault();
                const draggingElement = container.querySelector('.opacity-50');
                if (draggingElement && draggingElement !== this) {
                    const rect = this.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        this.style.borderTop = '2px solid #8b5cf6';
                        this.style.borderBottom = '';
                    } else {
                        this.style.borderTop = '';
                        this.style.borderBottom = '2px solid #8b5cf6';
                    }
                }
            });
            
            bulletPoint.addEventListener('dragleave', function(e) {
                this.style.borderTop = '';
                this.style.borderBottom = '';
            });
            
            bulletPoint.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderTop = '';
                this.style.borderBottom = '';
                
                const draggingElement = container.querySelector('.opacity-50');
                if (draggingElement && draggingElement !== this) {
                    const rect = this.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        container.insertBefore(draggingElement, this);
                    } else {
                        container.insertBefore(draggingElement, this.nextSibling);
                    }
                    
                    // Save data after reordering
                    saveFormData();
                    
                    // Trigger real-time preview update
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        updateResumePreview();
                    }, 500);
                }
            });
        }
        
        // Initialize bullet point listeners for the first experience item
        attachBulletPointListeners(document.querySelector('.experience-item'));
        
        // Attach drag and drop to existing bullet points
        document.querySelectorAll('.bullet-point-item').forEach(item => {
            const container = item.closest('.job-description-points');
            if (container) {
                attachDragAndDropListeners(item, container);
            }
        });
        
        // Load saved data and setup auto-save
        loadFormData();
        loadKeywordsFromStorage();
        setupAutoSave();
        setupRealTimePreview();

        // Add Education
        document.getElementById('addEducation').addEventListener('click', function() {
            const container = document.getElementById('educationContainer');
            const newItem = container.children[0].cloneNode(true);
            
            // Clear the values
            newItem.querySelectorAll('input').forEach(input => input.value = '');
            container.appendChild(newItem);
            
            // Trigger real-time preview update
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                updateResumePreview();
            }, 500);
        });

        // Add Project
        document.getElementById('addProject').addEventListener('click', function() {
            const container = document.getElementById('projectContainer');
            const newItem = container.children[0].cloneNode(true);
            
            // Clear the values
            newItem.querySelectorAll('input').forEach(input => input.value = '');
            
            // Reset bullet points to just one
            const bulletPointsContainer = newItem.querySelector('.project-description-points');
            bulletPointsContainer.innerHTML = `
                <div class="bullet-point-item flex gap-2" draggable="true">
                    <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                        </svg>
                    </div>
                    <input type="text" name="project_description_points[]" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" style="display: none;">√ó</button>
                </div>
            `;
            
            // Reattach event listeners
            attachProjectBulletPointListeners(newItem);
            
            // Attach drag and drop to the new bullet point
            const newBulletPoint = bulletPointsContainer.querySelector('.bullet-point-item');
            attachDragAndDropListeners(newBulletPoint, bulletPointsContainer);
            
            container.appendChild(newItem);
            
            // Trigger real-time preview update
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                updateResumePreview();
            }, 500);
        });

        // Project bullet point functionality
        function attachProjectBulletPointListeners(container) {
            // Add bullet point
            container.querySelector('.add-project-bullet-point').addEventListener('click', function() {
                const bulletPointsContainer = container.querySelector('.project-description-points');
                const newBulletPoint = document.createElement('div');
                newBulletPoint.className = 'bullet-point-item flex gap-2';
                newBulletPoint.draggable = true;
                newBulletPoint.innerHTML = `
                    <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                        </svg>
                    </div>
                    <input type="text" name="project_description_points[]" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium">√ó</button>
                `;
                bulletPointsContainer.appendChild(newBulletPoint);
                
                // Attach drag and drop listeners to new bullet point
                attachDragAndDropListeners(newBulletPoint, bulletPointsContainer);
                
                // Show remove buttons if more than one bullet point
                const bulletPoints = bulletPointsContainer.querySelectorAll('.bullet-point-item');
                bulletPoints.forEach((item, index) => {
                    const removeBtn = item.querySelector('.remove-bullet-point');
                    if (bulletPoints.length > 1) {
                        removeBtn.style.display = 'block';
                    } else {
                        removeBtn.style.display = 'none';
                    }
                });
                
                // Save data after adding bullet point
                saveFormData();
                
                // Trigger real-time preview update
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(() => {
                    updateResumePreview();
                }, 500);
            });

            // Remove bullet point
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-bullet-point')) {
                    const bulletPointItem = e.target.closest('.bullet-point-item');
                    const bulletPointsContainer = bulletPointItem.parentElement;
                    bulletPointItem.remove();
                    
                    // Hide remove button if only one bullet point remains
                    const remainingBulletPoints = bulletPointsContainer.querySelectorAll('.bullet-point-item');
                    remainingBulletPoints.forEach((item, index) => {
                        const removeBtn = item.querySelector('.remove-bullet-point');
                        if (remainingBulletPoints.length > 1) {
                            removeBtn.style.display = 'block';
                        } else {
                            removeBtn.style.display = 'none';
                        }
                    });
                    
                    // Save data after removing bullet point
                    saveFormData();
                    
                    // Trigger real-time preview update
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        updateResumePreview();
                    }, 500);
                }
            });
        }

        // Initialize project bullet point listeners for the first project item
        attachProjectBulletPointListeners(document.querySelector('.project-item'));

        // Refresh Preview Button
        document.getElementById('previewBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.textContent;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = `
                <span class="flex items-center gap-2 justify-center">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                    </svg>
                    Updating...
                </span>
            `;
            
            try {
                await updateResumePreview();
            } catch (err) {
                console.error('Failed to refresh preview:', err);
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        });

        // Download PDF Button
        document.getElementById('downloadPdfBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.textContent;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = `
                <span class="flex items-center gap-2 justify-center">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                    </svg>
                    Generating PDF...
                </span>
            `;
            
            try {
                // Get current form data
                const formData = new FormData(document.getElementById('resumeForm'));
                const data = {};
                
                // Collect form data
                for (let [key, value] of formData.entries()) {
                    if (key.endsWith('[]')) {
                        const baseKey = key.slice(0, -2);
                        if (!data[baseKey]) data[baseKey] = [];
                        data[baseKey].push(value);
                    } else {
                        data[key] = value;
                    }
                }
                
                // Process bullet points for job descriptions
                data.job_description = [];
                const experienceItems = document.querySelectorAll('.experience-item');
                
                experienceItems.forEach((item, index) => {
                    const bulletPoints = item.querySelectorAll('input[name="job_description_points[]"]');
                    const points = [];
                    
                    bulletPoints.forEach(input => {
                        if (input.value.trim()) {
                            points.push(input.value.trim());
                        }
                    });
                    
                    if (points.length > 0) {
                        data.job_description.push(points);
                    } else {
                        data.job_description.push([]);
                    }
                });
                
                // Process bullet points for project descriptions
                data.project_description = [];
                const projectItems = document.querySelectorAll('.project-item');
                
                projectItems.forEach((item, index) => {
                    const bulletPoints = item.querySelectorAll('input[name="project_description_points[]"]');
                    const points = [];
                    
                    bulletPoints.forEach(input => {
                        if (input.value.trim()) {
                            points.push(input.value.trim());
                        }
                    });
                    
                    if (points.length > 0) {
                        data.project_description.push(points);
                    } else {
                        data.project_description.push([]);
                    }
                });
                
                // Add template
                data.template = document.getElementById('template').value;
                
                // Validate required fields
                const requiredFields = ['name', 'email', 'phone', 'summary'];
                for (const field of requiredFields) {
                    if (!data[field]) {
                        alert(`Please fill in the ${field} field before generating PDF.`);
                        return;
                    }
                }
                
                // Generate and download PDF
                const response = await fetch('/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // Create a blob from the PDF data
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.name.replace(' ', '_')}_Resume.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to generate PDF: ${errorData.error}`);
                }
            } catch (err) {
                console.error('Failed to generate PDF:', err);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        });

        // Add keyword selection popup
        const popup = document.createElement('div');
        popup.id = 'keywordSelectionPopup';
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        popup.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold mb-4">Select Keywords to Include</h3>
                <p class="text-sm text-gray-600 mb-4">Choose keywords to naturally incorporate into your bullet point:</p>
                <div id="keywordSelectionList" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                <div class="flex justify-end gap-2">
                    <button id="cancelKeywordSelection" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button id="confirmKeywordSelection" class="px-4 py-2 bg-[#8B4513] text-white rounded hover:bg-[#A0522D]">Confirm</button>
                </div>
            </div>
        `;
        document.body.appendChild(popup);
        
        // Setup popup event listeners
        document.getElementById('cancelKeywordSelection').onclick = () => {
            popup.classList.add('hidden');
        };
        
        document.getElementById('confirmKeywordSelection').onclick = () => {
            const selectedKeywords = Array.from(document.querySelectorAll('#keywordSelectionList input:checked')).map(input => input.value);
            window.selectedKeywordsForRewrite = selectedKeywords;
            popup.classList.add('hidden');
            
            // Proceed with AI rewrite
            if (window.pendingRewriteFunction) {
                window.pendingRewriteFunction();
                window.pendingRewriteFunction = null;
            }
        };
        
        // Show keyword selection popup
        function showKeywordSelectionPopup(callback) {
            const popup = document.getElementById('keywordSelectionPopup');
            const list = document.getElementById('keywordSelectionList');
            
            if (!extractedKeywords || extractedKeywords.length === 0) {
                alert('No keywords available. Please extract keywords from a job description first.');
                return false;
            }
            
            list.innerHTML = '';
            extractedKeywords.forEach(keyword => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="checkbox" id="kw_${keyword}" value="${keyword}" class="rounded">
                    <label for="kw_${keyword}" class="text-sm">${keyword}</label>
                `;
                list.appendChild(div);
            });
            
            window.pendingRewriteFunction = callback;
            popup.classList.remove('hidden');
            return true;
        }
        
        // AI Rewrite functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('ai-rewrite-btn')) {
                const experienceItem = e.target.closest('.experience-item');
                const bulletPointsContainer = experienceItem.querySelector('.job-description-points');
                const bulletPoints = bulletPointsContainer.querySelectorAll('input[name="job_description_points[]"]');
                
                // Collect current bullet points
                const currentPoints = [];
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        currentPoints.push(input.value.trim());
                    }
                });
                
                if (currentPoints.length === 0) {
                    alert('Please add some bullet points before using AI rewrite.');
                    return;
                }
                
                // Show keyword selection popup first
                const rewriteFunction = () => {
                    // Show loading state
                    const originalText = e.target.textContent;
                    e.target.disabled = true;
                    e.target.innerHTML = `
                        <span class="flex items-center gap-1">
                            <svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                            </svg>
                            Rewriting...
                        </span>
                    `;
                    
                    // Call AI rewrite API with keywords
                    rewriteJobDescription(currentPoints, bulletPointsContainer, e.target, originalText);
                };
                
                if (!showKeywordSelectionPopup(rewriteFunction)) {
                    // No keywords available, proceed without keywords
                    rewriteFunction();
                }
            }
            
            if (e.target.classList.contains('ai-rewrite-project-btn')) {
                const projectItem = e.target.closest('.project-item');
                const bulletPointsContainer = projectItem.querySelector('.project-description-points');
                const bulletPoints = bulletPointsContainer.querySelectorAll('input[name="project_description_points[]"]');
                
                // Collect current bullet points
                const currentPoints = [];
                bulletPoints.forEach(input => {
                    if (input.value.trim()) {
                        currentPoints.push(input.value.trim());
                    }
                });
                
                if (currentPoints.length === 0) {
                    alert('Please add some bullet points before using AI rewrite.');
                    return;
                }
                
                // Show keyword selection popup first
                const rewriteFunction = () => {
                    // Show loading state
                    const originalText = e.target.textContent;
                    e.target.disabled = true;
                    e.target.innerHTML = `
                        <span class="flex items-center gap-1">
                            <svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                            </svg>
                            Rewriting...
                        </span>
                    `;
                    
                    // Call AI rewrite API for projects with keywords
                    rewriteProjectDescription(currentPoints, bulletPointsContainer, e.target, originalText);
                };
                
                if (!showKeywordSelectionPopup(rewriteFunction)) {
                    // No keywords available, proceed without keywords
                    rewriteFunction();
                }
            }
        });

        async function rewriteJobDescription(currentPoints, bulletPointsContainer, button, originalText) {
            try {
                const selectedKeywords = window.selectedKeywordsForRewrite || [];
                
                // Debug: Log what we're sending
                console.log("=== SENDING AI REWRITE REQUEST ===");
                console.log("Bullet points:", currentPoints);
                console.log("Selected keywords:", selectedKeywords);
                console.log("Full request body:", {
                    bullet_points: currentPoints,
                    selected_keywords: selectedKeywords
                });
                console.log("===================================");
                
                const response = await fetch('/ai-rewrite-job-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bullet_points: currentPoints,
                        selected_keywords: selectedKeywords
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const rewrittenPoints = result.rewritten_points;
                    
                    // Clear existing bullet points
                    bulletPointsContainer.innerHTML = '';
                    
                    // Add rewritten bullet points
                    rewrittenPoints.forEach((point, index) => {
                        const bulletPointItem = document.createElement('div');
                        bulletPointItem.className = 'bullet-point-item flex gap-2';
                        bulletPointItem.draggable = true;
                        
                        bulletPointItem.innerHTML = `
                            <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                </svg>
                            </div>
                            <input type="text" name="job_description_points[]" value="${point}" placeholder="Bullet point..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${rewrittenPoints.length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                        `;
                        
                        bulletPointsContainer.appendChild(bulletPointItem);
                    });
                    
                    // Re-attach event listeners for the new bullet points
                    attachBulletPointListeners(bulletPointsContainer.closest('.experience-item'));
                    
                    // Save data and update preview
                    saveFormData();
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        updateResumePreview();
                    }, 500);
                    
                    // Show success message
                    showNotification('Job description rewritten successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to rewrite job description');
                }
            } catch (error) {
                console.error('AI rewrite error:', error);
                showNotification('Failed to rewrite job description. Please try again.', 'error');
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        async function rewriteProjectDescription(currentPoints, bulletPointsContainer, button, originalText) {
            try {
                const selectedKeywords = window.selectedKeywordsForRewrite || [];
                
                // Debug: Log what we're sending
                console.log("=== SENDING AI REWRITE PROJECT REQUEST ===");
                console.log("Bullet points:", currentPoints);
                console.log("Selected keywords:", selectedKeywords);
                console.log("Full request body:", {
                    bullet_points: currentPoints,
                    selected_keywords: selectedKeywords
                });
                console.log("=========================================");
                
                const response = await fetch('/ai-rewrite-project-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bullet_points: currentPoints,
                        selected_keywords: selectedKeywords
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const rewrittenPoints = result.rewritten_points;
                    
                    // Clear existing bullet points
                    bulletPointsContainer.innerHTML = '';
                    
                    // Add rewritten bullet points
                    rewrittenPoints.forEach((point, index) => {
                        const bulletPointItem = document.createElement('div');
                        bulletPointItem.className = 'bullet-point-item flex gap-2';
                        bulletPointItem.draggable = true;
                        
                        bulletPointItem.innerHTML = `
                            <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2 py-2 flex items-center">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M7 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 2zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 7 14zm6-8a2 2 0 1 1-.001-4.001A2 2 0 0 1 13 6zm0 2a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 8zm0 6a2 2 0 1 1 .001 4.001A2 2 0 0 1 13 14z"/>
                                </svg>
                            </div>
                            <input type="text" name="project_description_points[]" value="${point}" placeholder="Project achievement or feature..." class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button type="button" class="remove-bullet-point text-red-500 hover:text-red-700 px-2 py-2 text-sm font-medium" ${rewrittenPoints.length > 1 ? '' : 'style="display: none;"'}>√ó</button>
                        `;
                        
                        bulletPointsContainer.appendChild(bulletPointItem);
                    });
                    
                    // Re-attach event listeners for the new bullet points
                    attachProjectBulletPointListeners(bulletPointsContainer.closest('.project-item'));
                    
                    // Save data and update preview
                    saveFormData();
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        updateResumePreview();
                    }, 500);
                    
                    // Show success message
                    showNotification('Project description rewritten successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to rewrite project description');
                }
            } catch (error) {
                console.error('AI rewrite error:', error);
                showNotification('Failed to rewrite project description. Please try again.', 'error');
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-white text-sm font-medium transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-600');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600');
            } else {
                notification.classList.add('bg-blue-600');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

    </script>
</body>
</html> 